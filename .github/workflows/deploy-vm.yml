name: Deploy Backend to Azure VM

on:
  push:
    branches:
      - main
    paths:
      - 'projeto-backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Backend via SSH

    steps:
      - name: Deploy Backend to Azure VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e

            PROJECT_DIR="/home/back/htdocs/back.dev-core.online/gestao-organizacional-python"
            BACKEND_DIR="$PROJECT_DIR/projeto-backend"

            echo "==> Pulling latest changes..."
            cd $PROJECT_DIR
            git fetch origin main
            git reset --hard origin/main

            echo "==> Installing backend dependencies..."
            cd $BACKEND_DIR
            # Removido o sudo chown daqui, pois o chown manual já resolveu
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            # Upgrade do pip ajuda a evitar erros de permissão em versões antigas
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet

            echo "==> Restarting gestao-backend service..."
            sudo systemctl restart gestao-backend

            echo "==> Checking service status..."
            sudo systemctl is-active gestao-backend

            echo "==> Backend deploy completed successfully!"
